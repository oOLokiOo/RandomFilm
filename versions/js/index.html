<!DOCTYPE html>
<html>
<head>
	<title>Random movie that you would like to revise (c) Script by oOLokiOo</title>
	<meta charset="utf-8">

	<link rel="stylesheet" href="../../css/style.css" />

	<script src="../../users/1/films.js"></script>
	<script type="text/javascript">
		var APP = {
			films: films,
			serials: [],
			cartoons: [],
			random_movie: null,
			settings: {
				// https://developers.google.com/image-search/v1/jsondevguide
				google_images_url: "http://ajax.googleapis.com/ajax/services/search/images?v=1.0&imgsz=large&rsz=8&q=",
				en_search_prefix: " film poster",
				ru_search_prefix: " фильм постер",
				blocked_resources: [
					'www.impawards.com',
					'en.wikipedia.org'
				]
			},
			init: function() {
				var rand = this.rand(0, this.films.length - 1);
				var random_movie = this.films[rand];
				var search_movie_title = "";

				this.getBySelector("button")[0].onclick = function() { location.reload(true); }
				this.random_movie = random_movie;

				if (random_movie && random_movie.en && random_movie.en != "") search_movie_title = random_movie.en 
					+ (this.random_movie.year ? " " 
					+ this.random_movie.year : "") 
					+ this.settings.en_search_prefix;

				else if (random_movie && random_movie.ru && random_movie.ru != "") search_movie_title = random_movie.ru 
					+ (this.random_movie.year ? " " 
					+ this.random_movie.year : "") 
					+ this.settings.en_search_prefix; // ru_search_prefix - bad result with "ru"

				if (search_movie_title != "") {
					var self = this;

					this.getJSONP(this.settings.google_images_url + search_movie_title + "&callback=?", function(json) {
						if (json && json.responseData.results) {
							var title = (self.random_movie.ru ? self.random_movie.ru + " | " : "")
								+ (self.random_movie.en ? self.random_movie.en + " | ": "")
								+ (self.random_movie.year ? self.random_movie.year : "");
							
							if (title.slice(-2) == "| ") title = title.slice(0, -2);
							
							self.getBySelector("main>h1")[0].innerHTML = "<a target='_blank' href='http://google.com/search?q="
								+ title.replace(/ \| /g, " ")
								+ " смотреть фильм онлайн'>"
								+ title
								+ "</a>";
							self.getBySelector("main>img")[0].src = self.filterFromBlockedResources(json.responseData.results);
							self.getBySelector("main>img")[0].alt = title;
							self.getBySelector("main>img")[0].title = title;

							if (self.random_movie.kinopoisk) {
								self.getById("kinopoisk").href = self.random_movie.kinopoisk;
								self.getById("kinopoisk").style.display = "inline";
							}

							if (self.random_movie.imdb) {
								self.getById("imdb").href = self.random_movie.imdb;
								self.getById("imdb").style.display = "inline";
							}
						}
						else alert("Movie [" + rand + "] : Image not found!");
					});
				}
				else alert("Movie [" + rand + "] - not found!");
			},
			rand: function (min, max) {
				return Math.round(min - 0.5 + Math.random() * (max - min + 1));
			},
			_filter: function(param) {
				return ((param && param != "") ? param : null);
			},
			getById: function(id) {
				return (this._filter(id) ? document.getElementById(id) : null);
			},
			getBySelector: function(selector) {
				return (this._filter(selector) ? document.querySelectorAll(selector) : null);
			},
			getJSONP: function(url, callback) {
/*
				var script = document.createElement('script');
				script.src = this.settings.google_images_url + search_movie_title;
				document.getElementsByTagName('head')[0].appendChild(script);
*/
				// http://stackoverflow.com/questions/32302518/javascript-cross-domain-json-object-reader
				var ud = "_" + +new Date,
					script = document.createElement('script'),
					head = document.getElementsByTagName('head')[0] || document.documentElement;

				window[ud] = function(data) {
					head.removeChild(script);
					callback && callback(data);
				};

				script.src = url.replace('callback=?', 'callback=' + ud);
				head.appendChild(script);
			},
			filterFromBlockedResources: function(arr) {
				var good_url = "";

				for (var i in arr) {
					if (this.settings.blocked_resources.join(" ").indexOf(arr[i].visibleUrl) < 0) {
						good_url = arr[i].url;
						break;
					}
				}

				return (good_url == "" ? arr[0].url : good_url);
			}
		};

		var DOMReady = function(a,b,c){b=document,c='addEventListener';b[c]?b[c]('DOMContentLoaded',a):window.attachEvent('onload',a)}
		DOMReady(function() {
			APP.init();
		});
	</script>
</head>
<body>
	<header>
	</header>

	<main>
		<h1></h1>
		<button type="button">Get Film!</button>
		<section>
			<a href="#" target="_blank" id="kinopoisk">kinopoisk</a>
			<a href="#" target="_blank" id="imdb">imdb</a>
		</section>
		<img src="" alt="" title="" />
	</main>

	<footer>
	</footer>
</body>
</html>