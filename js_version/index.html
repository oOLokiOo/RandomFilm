<!DOCTYPE html>
<html>
<head>
	<title>Random movie that you would like to revise (c) Script by oOLokiOo</title>

	<meta charset="utf-8">

	<link rel="stylesheet" href="../css/style.css" />

	<!-- WITHOUT INTERNET -->
	<!--script src="js/jquery-1.11.3.min.js"></script-->
	<!-- WITH INTERNET -->
	<!--script src="//code.jquery.com/jquery-1.11.3.min.js"></script-->

	<script src="../users/1/films.js"></script>
	<script type="text/javascript">
		var APP = {
			films: films,
			serials: [],
			cartoons: [],
			random_movie: null,
			settings: {
				google_images_url: "http://ajax.googleapis.com/ajax/services/search/images?v=1.0&q=",
				en_search_prefix: " film poster",
				ru_search_prefix: " фильм обложка",
			},
			init: function() {
				var rand = this.rand(0, this.films.length - 1);

				var random_movie = this.films[rand];
				this.random_movie = random_movie;

				var search_movie_title = "";

				if (random_movie && random_movie.en && random_movie.en != "") search_movie_title = random_movie.en 
					+ (this.random_movie.year ? " " 
					+ this.random_movie.year : "") 
					+ this.settings.en_search_prefix;
				else if (random_movie && random_movie.ru && random_movie.ru != "") search_movie_title = random_movie.ru 
					+ (this.random_movie.year ? " " 
					+ this.random_movie.year : "") 
					+ this.settings.ru_search_prefix;

				if (search_movie_title != "") {
					var self = this;

					// NO JQUERY VERSION
					this.getJSONP(this.settings.google_images_url + search_movie_title + "&callback=?", function(json) {

					// JQUERY VERSION
					//this.jQueryGetJSONP(this.settings.google_images_url + search_movie_title + "&callback=?", function(json) {
						if (json && json.responseData.results) {
							console.log(json.responseData.results);
							console.log(json.responseData.results[0].url);

							var title = (self.random_movie.ru ? self.random_movie.ru + " | " : "") + (self.random_movie.en ? self.random_movie.en + " | ": "") + (self.random_movie.year ? self.random_movie.year : "");
							if (title.slice(-2) == "| ") title = title.slice(0, -2);
							
							self.getBySelector("main>h1")[0].innerHTML = "<a target='_blank' href='http://google.com/search?q="+ title.replace(/\|/g, "") + " смотреть фильм онлайн'>" + title + "</a>";
							self.getBySelector("main>img")[0].src = json.responseData.results[0].url;
							self.getBySelector("main>img")[0].alt = title;
							self.getBySelector("main>img")[0].title = title;

							if (self.random_movie.kinopoisk) {
								self.getById("kinopoisk").href = self.random_movie.kinopoisk;
								self.getById("kinopoisk").style.display = "inline";
							}

							if (self.random_movie.imdb) {
								self.getById("imdb").href = self.random_movie.imdb;
								self.getById("imdb").style.display = "block";
							}
						}
						else alert("Movie [" + rand + "] : Image not found!");
					});
				}
				else alert("Movie [" + rand + "] - not found!");
			},
			_filter: function(param) {
				return ((param && param != "") ? param : null);
			},
			getById: function(id) {
				return (this._filter(id) ? document.getElementById(id) : null);
			},
			getBySelector: function(selector) {
				return (this._filter(selector) ? document.querySelectorAll(selector) : null);
			},
			rand: function (min, max) {
				return Math.round(min - 0.5 + Math.random() * (max - min + 1));
			},
			getJSONP: function(url, callback) {
/*
				var script = document.createElement('script');
				script.src = this.settings.google_images_url + search_movie_title;
				document.getElementsByTagName('head')[0].appendChild(script);
*/
				// http://stackoverflow.com/questions/32302518/javascript-cross-domain-json-object-reader
				var ud = "_" + +new Date,
					script = document.createElement('script'),
					head = document.getElementsByTagName('head')[0]
					|| document.documentElement;

				window[ud] = function(data) {
					head.removeChild(script);
					callback && callback(data);
				};

				script.src = url.replace('callback=?', 'callback=' + ud);
				head.appendChild(script);
			},
			jQueryGetJSONP: function(url, callback) {
				$.ajax({
					url: url,
					dataType: "jsonp", 
					success: function(json) {
						callback(json);
					},
					error: function() {
						callback(null);
					}
				});
			}
		};

		var DOMReady = function(a,b,c){b=document,c='addEventListener';b[c]?b[c]('DOMContentLoaded',a):window.attachEvent('onload',a)}
		DOMReady(function() {
		//$(document).ready(function() {
			APP.init();
		});
	</script>
</head>
<body>
	<header>
	</header>

	<main>
		<h1></h1>
		<section>
			<a href="#" target="_blank" id="kinopoisk">kinopoisk</a>
			<a href="#" target="_blank" id="imdb">imdb</a>
		</section>
		<img src="" alt="" title="" />
	</main>

	<footer>
	</footer>
</body>
</html>